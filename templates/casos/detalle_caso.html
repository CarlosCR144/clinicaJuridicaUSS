{% extends "base.html" %}

{% block title %}Caso {{ caso.rol_rit }}{% endblock %}

{% block content %}
{% if alertas_integridad %}
<div class="alert alert-danger shadow-sm mb-4 border-danger border-start border-4" role="alert">
    <div class="d-flex align-items-center mb-2">
        <i class="bi bi-shield-exclamation-fill fs-4 me-2"></i>
        <h5 class="alert-heading fw-bold mb-0">Integridad de Archivos Comprometida</h5>
    </div>
    <p class="mb-0">El sistema ha detectado inconsistencias críticas:</p>
    
    <div class="vstack gap-2 mt-3">
        {% for alerta in alertas_integridad %}
            <div class="d-flex justify-content-between align-items-center bg-white bg-opacity-50 p-2 rounded border border-danger border-opacity-25">
                <span>
                    <i class="bi bi-file-earmark-x me-2"></i>{{ alerta.mensaje }}
                </span>
                
                {% if user.rol == 'director' or user.rol == 'supervisor' %}
                    {% if alerta.tipo == 'modificado' and alerta.documento.estado != 'rechazado' %}
                        <form action="{% url 'documentos:cambiar_estado' alerta.documento.id 'rechazar' %}" method="post">
                            {% csrf_token %}
                            <input type="hidden" name="motivo_rechazo" value="RECHAZO AUTOMÁTICO POR SEGURIDAD: El hash del archivo no coincide (Integridad Comprometida).">
                            <button type="submit" class="btn btn-danger btn-sm fw-bold shadow-sm">
                                <i class="bi bi-shield-x me-1"></i> Rechazar por Seguridad
                            </button>
                        </form>
                    {% elif alerta.documento.estado == 'rechazado' %}
                        <span class="badge bg-danger">Ya rechazado</span>
                    {% endif %}
                {% endif %}
            </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="d-flex justify-content-between align-items-start mb-4">
  <div>
      <h2 class="h3 fw-bold text-dark mb-1">{{ caso.rol_rit }}</h2>
      <p class="text-muted mb-0 fs-5">{{ caso.caratula }}</p>
  </div>
  <div class="d-flex gap-2">
      {% if user.rol == 'director' or user.rol == 'supervisor' %}
        <a href="{% url 'casos:editar' caso.id %}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-pencil me-1"></i> Editar
        </a>
      {% endif %}

      {% if user.rol == 'director' or user.rol == 'supervisor' or user == caso.responsable %}
        <a href="{% url 'casos:editar_registro' caso.id %}"
          class="btn btn-outline-dark btn-sm">
          Registro interno
        </a>
      {% endif %}


      <a href="{% url 'casos:lista' %}" class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i> Volver
      </a>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-8">

    {% if user.rol == 'director' or user.rol == 'supervisor' %}
    <div class="card card-modern mb-4 border-start border-4 border-primary">
        <div class="card-body d-flex justify-content-between align-items-center">
            <div>
                <h6 class="fw-bold mb-1 text-primary">Control de Estado</h6>
                <div class="small">Actual: <span class="fw-semibold">{{ caso.get_estado_display }}</span></div>
            </div>
            <div class="d-flex gap-2">
                {% if caso.estado == 'en_estudio' and user.rol == 'director' %}
                    <button type="button" class="btn btn-outline-danger btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#confirmActionModal"
                            data-action-url="{% url 'casos:cambiar_estado' caso.id 'rechazar' %}"
                            data-title="Rechazar Causa"
                            data-message="¿Estás seguro de declarar INADMISIBLE esta causa? Se archivará el expediente."
                            data-btn-class="btn-danger" data-btn-text="Rechazar">
                        Rechazar
                    </button>
                    
                    <button type="button" class="btn btn-success btn-sm text-white" 
                            data-bs-toggle="modal" data-bs-target="#confirmActionModal"
                            data-action-url="{% url 'casos:cambiar_estado' caso.id 'admitir' %}"
                            data-title="Admitir Causa"
                            data-message="¿Declarar ADMISIBLE e iniciar tramitación?"
                            data-btn-class="btn-success" data-btn-text="Admitir">
                        <i class="bi bi-check-lg me-1"></i> Admitir
                    </button>
                {% endif %}

                {% if caso.estado == 'en_tramite' %}
                    <button type="button" class="btn btn-outline-secondary btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#confirmActionModal"
                            data-action-url="{% url 'casos:cambiar_estado' caso.id 'archivar' %}"
                            data-title="Archivar Causa"
                            data-message="¿Deseas archivar este caso sin sentencia?"
                            data-btn-class="btn-secondary" data-btn-text="Archivar">
                        Archivar
                    </button>

                    <button type="button" class="btn btn-primary btn-sm" 
                            data-bs-toggle="modal" data-bs-target="#confirmActionModal"
                            data-action-url="{% url 'casos:cambiar_estado' caso.id 'finalizar' %}"
                            data-title="Finalizar Causa"
                            data-message="¿Marcar caso como FINALIZADO con sentencia? Esta acción cerrará el expediente."
                            data-btn-class="btn-primary" data-btn-text="Finalizar">
                        Sentencia / Cierre
                    </button>
                {% endif %}
                
                {% if caso.estado == 'archivada' or caso.estado == 'con_sentencia' %}
                    <span class="badge bg-secondary">Cerrado</span>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="card card-modern mb-4">
      <div class="card-header-modern">
        <i class="bi bi-info-circle me-2"></i>Información General
      </div>
      <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Cliente</small>
                <span class="fs-5">{{ caso.cliente }}</span>
            </div>
            <div class="col-md-6">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Responsable</small>
                <div class="d-flex align-items-center mt-1">
                    <div class="rounded-circle bg-primary text-white d-flex justify-content-center align-items-center me-2" style="width: 28px; height: 28px; font-size: 0.8rem;">
                        {{ caso.responsable.first_name|slice:":1" }}
                    </div>
                    <span>{{ caso.responsable.get_full_name }}</span>
                </div>
            </div>
            <div class="col-md-4">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Tribunal</small>
                {{ caso.tribunal }}
            </div>
            <div class="col-md-4">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Materia</small>
                {{ caso.materia }}
            </div>
            <div class="col-md-4">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Ingreso</small>
                {{ caso.fecha_ingreso|date:"d M Y" }}
            </div>
            <div class="col-12 pt-2">
                <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Descripción</small>
                <p class="mb-0 mt-1 text-secondary" style="white-space: pre-line;">{{ caso.descripcion }}</p>
            </div>
        </div>
      </div>
    </div>

    <div class="card card-modern mb-4">
      <div class="card-header-modern d-flex justify-content-between align-items-center">
        <span><i class="bi bi-people me-2"></i>Intervinientes</span>
        <a href="{% url 'casos:crear_participante' caso.id %}" class="btn btn-sm btn-light text-primary fw-bold">
            <i class="bi bi-plus"></i> Agregar
        </a>
      </div>
      <div class="table-responsive">
         <table class="table table-custom mb-0">
            <tbody>
                {% for part in caso.participantes.all %}
                <tr>
                    <td class="fw-medium">{{ part.persona }}</td>
                    <td><span class="badge bg-light text-dark border">{{ part.get_rol_display }}</span></td>
                    <td class="text-muted small">{{ part.observaciones|default:""|truncatechars:40 }}</td>
                </tr>
                {% empty %}
                <tr><td colspan="3" class="text-center text-muted small py-3">Solo el cliente principal registrado.</td></tr>
                {% endfor %}
            </tbody>
         </table>
      </div>
    </div>

    <div class="card card-modern mb-4">
      <div class="card-header-modern d-flex justify-content-between align-items-center">
        <span>
          <i class="bi bi-journal-text me-2"></i>Registro Interno del Caso
        </span>

        {% if user.rol == 'director' or user.rol == 'supervisor' or user == caso.responsable %}
          <a href="{% url 'casos:editar_registro' caso.id %}"
            class="btn btn-sm btn-outline-primary">
            Editar
          </a>
        {% endif %}
      </div>

      <div class="card-body">
        {% if caso.registro.contenido %}
          <div class="registro-preview">
            {{ caso.registro.contenido|linebreaks }}
          </div>
          <small class="text-muted d-block mt-2">
            Última actualización: {{ caso.registro.actualizado_en|date:"d/m/Y H:i" }}
          </small>
        {% else %}
          <p class="text-muted fst-italic mb-0">
            No hay registro interno aún.
          </p>
        {% endif %}
      </div>
    </div>


    <div class="card card-modern">
      <div class="card-header-modern">
        <i class="bi bi-clock-history me-2"></i>Historial de Movimientos
      </div>
      <div class="card-body">
        <div class="vstack gap-3">
        {% for log in caso.historial.all %}
          <div class="d-flex gap-3">
            <div class="d-flex flex-column align-items-center">
                <div class="rounded-circle bg-light border d-flex justify-content-center align-items-center" style="width: 32px; height: 32px;">
                    <i class="bi bi-activity text-muted"></i>
                </div>
                {% if not forloop.last %}<div class="bg-light flex-grow-1 my-1" style="width: 2px;"></div>{% endif %}
            </div>
            <div class="pb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="badge bg-light text-dark border">{{ log.get_accion_display }}</span>
                    <small class="text-muted">{{ log.fecha|date:"d/m/Y H:i" }}</small>
                </div>
                <p class="mb-0 small text-secondary">{{ log.detalle }}</p>
                <small class="text-muted fst-italic" style="font-size: 0.75rem;">Por: {{ log.usuario.get_full_name }}</small>
            </div>
          </div>
        {% empty %}
          <div class="text-center text-muted py-3">Sin movimientos registrados.</div>
        {% endfor %}
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    
    <div class="card card-modern mb-4">
      <div class="card-header-modern d-flex justify-content-between align-items-center">
        <span><i class="bi bi-files me-2"></i>Expediente Digital</span>
      </div>
      <div class="card-body p-0">
        <div class="list-group list-group-flush">
          {% for doc in documentos %}
            <div class="list-group-item px-3 py-3 border-bottom-0 border-top">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div class="fw-semibold text-truncate me-2">{{ doc.nombre }}</div>
                {% if doc.estado == 'pendiente' %}
                    <i class="bi bi-hourglass-split text-warning" title="Pendiente"></i>
                {% elif doc.estado == 'rechazado' %}
                    <i class="bi bi-x-circle-fill text-danger" title="Rechazado"></i>
                {% else %}
                    <i class="bi bi-check-circle-fill text-success" title="Oficial"></i>
                {% endif %}
              </div>
              <div class="d-flex justify-content-between align-items-end">
                  <span class="fw-semibold">
                    Documento N° {{ doc.orden_expediente }}
                  </span>
                  <small class="text-muted">
                    Folio Global {{ doc.id }}
                  </small>
                  {% comment %} <small class="text-muted">Documento N° {{ doc.orden_expediente }}</small> {% endcomment %}
                  <div class="btn-group">
                      <a href="{{ doc.archivo.url }}" target="_blank" class="btn btn-xs btn-light text-primary" title="Ver"><i class="bi bi-eye"></i></a>
                      
                      {% if user.rol == 'supervisor' or user.rol == 'director' %}
                        {% if doc.estado == 'pendiente' %}
                            <form action="{% url 'documentos:cambiar_estado' doc.id 'aprobar' %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-xs btn-success ms-1"><i class="bi bi-check"></i></button>
                            </form>
                            <button class="btn btn-xs btn-danger ms-1" data-bs-toggle="collapse" data-bs-target="#rechazo-{{ doc.id }}"><i class="bi bi-x"></i></button>
                        {% endif %}
                      {% endif %}
                  </div>
              </div>
              
              {% if user.rol == 'supervisor' or user.rol == 'director' %}
              <div class="collapse mt-2" id="rechazo-{{ doc.id }}">
                <form action="{% url 'documentos:cambiar_estado' doc.id 'rechazar' %}" method="post" class="input-group input-group-sm">
                    {% csrf_token %}
                    <input type="text" name="motivo_rechazo" class="form-control" placeholder="Motivo..." required>
                    <button class="btn btn-danger" type="submit">OK</button>
                </form>
              </div>
              {% endif %}
              
              {% if doc.estado == 'rechazado' %}
                <small class="d-block text-danger mt-1 bg-danger bg-opacity-10 p-1 rounded">Nota: {{ doc.observaciones_rechazo }}</small>
              {% endif %}
            </div>
          {% empty %}
            <div class="p-4 text-center text-muted small">No hay documentos.</div>
          {% endfor %}
        </div>
        
        {% if user.rol in 'director supervisor estudiante' %}
        <div class="p-3 border-top bg-light">
           <a href="{% url 'documentos:subir' caso.id %}" class="btn btn-outline-primary btn-sm w-100 border-dashed">
            <i class="bi bi-cloud-upload me-1"></i> Subir Documento
          </a>
        </div>
        {% endif %}
      </div>
    </div>

    <div class="card card-modern">
      <div class="card-header-modern d-flex justify-content-between align-items-center">
        <span><i class="bi bi-calendar-event me-2"></i>Agenda</span>
      </div>
      <div class="card-body p-0">
        {% for cita in citas %}
          <div class="p-3 border-bottom d-flex gap-3">
            <div class="text-center">
                <span class="d-block fw-bold text-dark">{{ cita.fecha_hora|date:"d" }}</span>
                <span class="d-block small text-muted text-uppercase">{{ cita.fecha_hora|date:"M" }}</span>
            </div>
            <div>
                <div class="fw-semibold text-primary">{{ cita.get_tipo_display }}</div>
                <small class="text-dark d-block">{{ cita.fecha_hora|time:"H:i" }} hrs</small>
                <small class="text-muted"><i class="bi bi-geo-alt me-1"></i>{{ cita.lugar }}</small>
            </div>
          </div>
        {% empty %}
          <div class="p-4 text-center text-muted small">No hay eventos próximos.</div>
        {% endfor %}
        
        <div class="p-3 border-top bg-light">
            <a href="{% url 'agenda:agendar_caso' caso.id %}" class="btn btn-outline-primary btn-sm w-100 border-dashed">
                <i class="bi bi-plus-lg me-1"></i> Agendar Evento
            </a>
        </div>
      </div>
    </div>

  </div>
</div>

<div class="modal fade" id="confirmActionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow">
      <div class="modal-header border-bottom-0 pb-0">
        <h5 class="modal-title fw-bold" id="modalTitle">Confirmar Acción</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body py-4">
        <p class="text-muted mb-0" id="modalMessage">¿Estás seguro?</p>
      </div>
      <div class="modal-footer border-top-0 pt-0">
        <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancelar</button>
        
        <form id="modalForm" method="post" action="">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary" id="modalConfirmBtn">Confirmar</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var confirmModal = document.getElementById('confirmActionModal');
        confirmModal.addEventListener('show.bs.modal', function (event) {
            // Botón que disparó el modal
            var button = event.relatedTarget;
            
            // Extraer datos del botón
            var title = button.getAttribute('data-title');
            var message = button.getAttribute('data-message');
            var url = button.getAttribute('data-action-url');
            var btnClass = button.getAttribute('data-btn-class');
            var btnText = button.getAttribute('data-btn-text');

            // Actualizar el modal
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('modalForm').action = url;
            
            var confirmBtn = document.getElementById('modalConfirmBtn');
            confirmBtn.className = 'btn ' + btnClass;
            confirmBtn.textContent = btnText;
        });
    });
</script>

{% endblock %}